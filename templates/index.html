<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <title>PCA based Image interpolation</title> -->

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v4.js" charset="utf-8"></script>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"> -->
    <style>
        .slidecontainer {
            width: 100%;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #337AB7;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #337AB7;
            cursor: pointer;
        }

        .sample-neighborhood-container {
            background-color: #333333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 20px;
        }

        .render-samples-container{
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            width: 100%;
            justify-content: center;
            padding: auto;
        }

        .sample-image-container {
            display: flex;
            flex-direction: row;
            margin: 10px;
            align-items: center;
        }
        .organ-description {
            padding: 10px;
            width: 150px;
            text-align: center;
            color: white;
            background-color: #595756;
            opacity: 0.8;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: medium;
            border-radius: 5px;
        }

        .organ-description:hover {
            opacity: 1;
        }

        .organ-description-green {
            background-color: #5cb85c;
            border-color: #4cae4c;
            opacity: 0.9;
        }

        .organ-description-red {
            background-color:rgb(223, 94, 94);
            opacity: 0.9;
        }

        .organ-description:hover {
            cursor: pointer;
        }

        .organ-description-green:hover {
            cursor: pointer;
        }

        .organ-description-red:hover {
            cursor: pointer;
        }
        
        .sample-image {
            height: 275px;
            width: 300px;
            margin-right: 10px;
        }

        .sample-image-border-green {
            border: 7px solid #5cb85c;
        }

        .sample-image-border-blue {
            border: 7px solid #2e6da4
            /* border: 7px solid rgb(223, 94, 94); */

        }

        .submit-preferences-button {
            padding: 15px;
            color: #fff;
            background-color: #337ab7;
            border-color: #2e6da4;
            font-weight: 600;
            font-size: large;
            align-self: center;
            margin-right: 20px;
        }
        .submit-preferences-button:hover {
            background-color: #0077b6;
        }
        .buttons-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }
    </style>
  </head>
  <title>CT Image generation using Reinforcement Learning</title>
<!-- Adding React -->
  <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>
  <body>
 <div class="container-fluid" style="background-color:  #303030">
     <div class="row">
         <!--<span class="border">-->
         <div class='col-6'>

             <div class='row mb-3'>
                 <div class='col' style="text-align:center; background-color:black;"><p style="color: white; font-weight:bold; vertical-align: center; font-size: 110%"> Sample Generation</p> </div>
             </div>

             <div class='row'>

                 <div class='col-3'>
<!--                      <div class='row'></div> -->
                     <div class="row">
                         <button type="button" class="btn btn-primary btn-block" onclick="generate()">Generate Samples</button>
                     </div>

                 </div>

                 <div class='col-3'>
                    <div class="row mb-3">
                        <img id="source" class="rounded mx-auto d-block" alt="..." width="180" height="180" style="width:180px height=180px">   
                    </div>
                 </div>

                 <div class='col-3'> 
                    <div class="row mb-3">
                        <img id="interpolated" class="rounded mx-auto d-block" alt="..." width="180" height="180" style="width:180px height=180px">
                    </div>
                 </div>

                 <div class='col-3'> 
                    <div class="row mb-3">
                        <img id="dest" class="rounded mx-auto d-block" alt="..." width="180" height="180" style="width:180px height=180px">
                    </div>
                 </div>
             </div>

             <div class="row mb-3">
                
                <div class='col-3'>
                  
                  <div class="row mb-3">

                     <div class="col">
                       <button type="button" class="btn btn-primary btn-block" id="dec_slider" onclick="decrement_slider()"><</button>
                     </div>

                     <div class="col">
                      <button type="button" class="btn btn-primary btn-block" id="inc_slider" onclick="increment_slider()">></button>
                     </div>
                  </div>

                </div>

                <div class="col-9">
                  
                  <div class="row mb-3">
                    <input type="range" min="0" max="100" value="0" class="slider" id="pca_slider" oninput="slider_response(this.value)">
                  </div>
                </div>

             </div>
             <!-- ENds -->

         </div>
         <!--</span>-->
         <div class='col-3'>
             
             <div class="row mb-3"> 
                <div class='col' style="text-align:center; background-color:black;"> <p style="color: white; font-weight:bold; vertical-align: center; font-size: 110%"> Sample Completion <p> </div>
             </div>

             <div class="row mb-3">

                 <div class="col-9">
                   <img id="source" class="rounded mx-auto d-block" alt="..." width="250" height="250" style="width:200px height=200px">
                 </div>

                 <div class="col-3">
                     
                     <div class="row mb-1"> 
                        <button type="button" class="btn btn-primary btn-block">Tissue</button>
                     </div>

                     <div class="row mb-3">
                       <button type="button" class="btn btn-primary btn-block">Pathology</button>
                     </div>
                     
                     <div class="row mb-6">
                       <button type="button" class="btn btn-primary btn-block">OK/Save</button>
                     </div>
                 </div>
             </div>
         </div>
         <div class='col-3'>
             <div class="row mb-1">
                <div class='col' style="text-align:center; background-color:black;"> <p style="color: white; font-weight:bold; vertical-align: center; font-size: 110%">Database Statistics</p>
                 </div>
             </div>
             <div class="row mb-1">Graphs</div>
         </div>
     </div>
     <!-- First Row done -->
<div class="row mb-1"> 
    <div class='col' style="text-align:center; background-color:black;"> <p style="color: white; font-weight:bold; vertical-align: center; font-size: 120%">Sample Neighborhood Enrichment</p>  
    </div>
</div>
 </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="{{url_for('static', filename='scripts/main.js')}}"></script>

    <div id="root"></div>
    <script type="text/babel">  
    const rootElement = document.getElementById('root')

    class Main extends React.Component { 
        constructor(props){
            super(props);
            this.state = {
                data: {},
                sampleImages: [],
                preferences: [],
                sliderValue: 0
            }
            this.handleLeftClick = this.handleLeftClick.bind(this);
            this.handleRightClick = this.handleRightClick.bind(this);
            this.submitPreferences = this.submitPreferences.bind(this);
            this.submitDefaultPreferences = this.submitDefaultPreferences.bind(this);
            this.setInitialPreferences = this.setInitialPreferences.bind(this);
            this.getSegments = this.getSegments.bind(this);
            this.set_slider_value = this.set_slider_value.bind(this);
            this.setImages = this.setImages.bind(this)   
            this.set_black_images = this.set_black_images.bind(this);
            this.reset_slider = this.reset_slider.bind(this);  
            this.reset_dashboard = this.reset_dashboard.bind(this); 
        }
        componentDidMount() {
            this.reset_dashboard();
        }

        set_black_images() {
            console.log("Setting Images");
            var img_tags = document.getElementsByTagName('img');

            for (var i=0; i< img_tags.length; i++)
            {
                img_tags[i].src = "/static/black_image.jpeg";
            }
        }

        getSegments() {
            fetch("/get_segments",{
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then(response => response.json())
            .then(data => {
                // Sample Imges URL to Images array
                let images = [];
                let defaultName = "sample_"
                for(let i=1;i<9;i++) {
                    let obj_key = defaultName + i;
                    images.push(data[obj_key])
                }
                this.setState({
                    data: {...data},
                    sampleImages: [...images],
                    sliderValue: data.level
                })
            })
            this.setInitialPreferences();
        }

        handleLeftClick(e,id, organ) {
            let temp_preferences = this.state.preferences;
            temp_preferences[id][organ] = '1';
            this.setState({
                preferences: temp_preferences
            })

        }

        handleRightClick(e, id, organ) {
            e.preventDefault()
            let temp_preferences = this.state.preferences;
            temp_preferences[id][organ] = '0';
            this.setState({
                preferences: temp_preferences
            })
        }

        submitDefaultPreferences() {
            let temp_samples = [1,2,3,4,5,6,7,8]
                let temp_preferences = []
                let temp_organ_preference = {
                    "Accept/Reject": null,
                    "Torso": "1",
                    "Left Lung": '0',
                    "Right Lung": '1',
                    "Spine": '1',
                    "Heart": '0'
                }
                for(let i=1; i<=temp_samples.length; i++)  {
                    let id = i.toString();
                    if(i%2 === 0) temp_preferences.push({...temp_organ_preference, "Accept/Reject":'1'})
                    else temp_preferences.push({...temp_organ_preference, "Accept/Reject":'0'})
                }
                this.setState({
                    preferences: [...temp_preferences]
                })
        }

        setInitialPreferences() {
            console.log("Initial Preferences");
            let temp_samples = [1,2,3,4,5,6,7,8]
            let temp_preferences = []
            let temp_organ_preference = {
                "Accept/Reject": null,
                "Torso": null,
                "Left Lung": null,
                "Right Lung": null,
                "Spine": null,
                "Heart": null
            }
            for(let i=1; i<=temp_samples.length; i++)  {
                let id = i.toString();
                temp_preferences.push({...temp_organ_preference})
            }
            this.setState({
                preferences: [...temp_preferences]
            })
        }

        submitPreferences() {
            let final_preferences = this.state.preferences;
            let complete_Flag = true;
            for(let i=0; i<final_preferences.length; i++) {
                let pref = final_preferences[i];
                for(let key in pref){
                    if(pref[key] === null) {
                        complete_Flag = false
                        break;
                    }
                }
                if(!complete_Flag) break;
            }
            if(complete_Flag){
                let pref_req = {}
                for(let i=0;i<final_preferences.length;i++){
                    pref_req[i+1] = {...final_preferences[i]}
                }
                $.ajax({
                    type:"POST",
                    url: "/submit_prefs",
                    dataType:'json',
                    data: {preferences: JSON.stringify(pref_req)},
                    success: function(data){
                       alert("All the preferences have been submitted")
                    }
                }).then(()=>{
                    this.reset_dashboard();
                })
            }
            else alert("Please submit the preferences for all the samples")
        }

        set_slider_value(){
            document.getElementById("pca_slider").value = this.state.sliderValue;
        }

        reset_slider(){
            this.setState({
                sliderValue: 0
            },()=> {
                this.set_slider_value()
            })
        }

        setImages() {
            document.getElementById("source").src = this.state.data.img1
            document.getElementById("dest").src = this.state.data.img2
            document.getElementById("interpolated").src = this.state.data.img_mid
        }

        reset_dashboard(){
            this.set_black_images();
            // this.setInitialPreferences();
            this.reset_slider();
            this.getSegments()
        }

        render() { 
            this.set_slider_value();
            if(Object.keys(this.state.data).length !== 0) this.setImages()
            let temp_samples = [1,2,3,4,5,6,7,8]
            const render_images = temp_samples.map((img_src,index) => {
                    // Update it to original images received
                    return (
                        <div key={index+1} >
                            {
                                this.state.preferences.length ?
                                <div className="sample-image-container">
                                    <img 
                                        src={"/static/black_image.jpeg"} 
                                        className={ this.state.preferences[index]["Accept/Reject"] === null
                                                            ? "sample-image"
                                                            :  this.state.preferences[index]["Accept/Reject"] === "1" 
                                                            ? "sample-image sample-image-border-green"
                                                            : "sample-image sample-image-border-blue" }
                                    />

                                    <div>
                                        <div 
                                            className={ this.state.preferences[index]["Torso"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Torso"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" } 
                                            onClick={(e=event,sample_id = index,organ="Torso") => this.handleLeftClick(e,sample_id,organ)} 
                                            onContextMenu={(e=event,sample_id = index,organ="Torso") => this.handleRightClick(e, sample_id, organ)}
                                        >
                                            Torso
                                        </div>
                                        <div 
                                            className={ this.state.preferences[index]["Left Lung"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Left Lung"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" }
                                            onClick={(e=event,sample_id = index,organ="Left Lung") => this.handleLeftClick(e,sample_id,organ)} 
                                            onContextMenu={(e=event,sample_id = index,organ="Left Lung")=> this.handleRightClick(e, sample_id, organ)}
                                        > 
                                            Lung (L)
                                        </div>
                                        <div 
                                        className={ this.state.preferences[index]["Right Lung"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Right Lung"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" }
                                        onClick={(e=event,sample_id = index,organ="Right Lung")=> this.handleLeftClick(e,sample_id,organ)}
                                        onContextMenu={(e=event,sample_id = index,organ="Right Lung")=> this.handleRightClick(e, sample_id, organ)}
                                        >
                                            Lung (R)
                                        </div>
                                        <div 
                                        className={ this.state.preferences[index]["Spine"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Spine"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" }
                                        onClick={(e=event,sample_id = index,organ="Spine") => this.handleLeftClick(e,sample_id,organ)} 
                                        onContextMenu={(e=event,sample_id = index,organ="Spine")=> this.handleRightClick(e, sample_id, organ)} 
                                        >
                                            Spine
                                        </div>
                                        <div 
                                        className={ this.state.preferences[index]["Heart"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Heart"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" }
                                        onClick={(e=event,sample_id = index,organ="Heart") => this.handleLeftClick(e,sample_id,organ)} 
                                        onContextMenu={(e=event,sample_id = index,organ="Heart")=> this.handleRightClick(e, sample_id, organ)} 
                                        >
                                            Heart
                                        </div>
                                        <div 
                                        className={ this.state.preferences[index]["Accept/Reject"] === null
                                                            ? "organ-description"
                                                            :  this.state.preferences[index]["Accept/Reject"] === "1" 
                                                            ? "organ-description organ-description-green"
                                                            : "organ-description organ-description-red" }
                                        onClick={(e=event,sample_id = index,organ="Accept/Reject") => this.handleLeftClick(e,sample_id,organ)} 
                                        onContextMenu={(e=event,sample_id = index,organ="Accept/Reject")=> this.handleRightClick(e, sample_id, organ)} 
                                        >
                                            Accept / Reject
                                        </div>
                                    </div>
                                </div>
                                : ""
                            }
                        </div>
                    )
                })
                
            return (
                <div className="sample-neighborhood-container">
                    <div className="render-samples-container">
                        {render_images}
                    </div>
                    <div className="buttons-container">
                        <button className="submit-preferences-button" onClick = {()=> this.submitDefaultPreferences()}>Default Preferences</button>
                        <button className="submit-preferences-button" onClick = {()=> this.setInitialPreferences()}>Reset Preferences</button>
                        <button className="submit-preferences-button" onClick = {()=> this.submitPreferences()}>Submit Preferences</button>
                    </div>
                </div>
            );
        }    
    }
    
    // Create a function to wrap up your component
    function App(){
        return(
            <div>
                <Main/>
            </div>
        )
    }

    ReactDOM.render(
      <App />,
      rootElement
    )
    </script>
  </body>

</html>